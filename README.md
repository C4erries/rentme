# Rentme — маркетплейс аренды жилья с ML‑оценкой

Rentme — учебный маркетплейс краткосрочной и долгосрочной аренды жилья (аналог Airbnb), в котором цена может подсказываться отдельным ML‑сервисом.  
Цель проекта — отработать архитектуру модульного монолита, выделение мессенджера в отдельный сервис, интеграцию ML‑ценообразования и админки.

Основной стек:
- Backend: Go + Gin, MongoDB, модульный монолит с DDD‑разделением (`internal/domain`, `internal/app`, `internal/infra`).
- Frontend: React + TypeScript + Vite + Tailwind.
- ML‑сервис: Python + FastAPI + scikit‑learn (`mlrent/`), общение по HTTP.
- Инфраструктура: `docker-compose` (backend, frontend, MongoDB, ML, MinIO/S3, ScyllaDB). Kafka и событийная архитектура **не используются**.

> Rentme is a marketplace for short‑ and long‑term rentals with an external ML pricing service, a separate messaging service, notifications, and an architecture that can later be split into microservices.

---

## Что мы строим

- Маркетплейс для множества арендодателей и объявлений, а не сайт одного ЖК/отеля.
- Два типа аренды:
  - краткосрочная (посуточная, `short_term`);
  - долгосрочная (от недель/месяцев, `long_term`).
- Для **каждого** типа аренды используется **своя ML‑модель** и **свой датасет**:
  - короткая и длинная аренда разделены на уровне данных и моделей;
  - интерфейс может показывать ML‑подсказку и для посуточной, и для долгосрочной цены.
- Все сервисы (backend, frontend, ML, MinIO, ScyllaDB) поднимаются одной командой через `docker-compose`.

---

## Архитектура

### Backend (Go) + отдельный сервис мессенджера

- Основной backend — модульный монолит:
  - `internal/domain` — чистые доменные модели и бизнес‑правила;
  - `internal/app` — use‑cases (команды/запросы), обработчики, политики;
  - `internal/infra` — HTTP, Mongo, адаптеры ML, MinIO и т.п.
- Доменные контексты в монолите:
  - `user` — пользователи (guest / host / admin);
  - `listings` — объявления, связанные с конкретным арендодателем (`HostID`);
  - `pricing` — расчёт и рекомендации цены через порт `pricing.Calculator`;
  - `availability` — календарь доступности;
  - `booking` — бронирования (заказы);
  - `reviews` — отзывы и агрегированный рейтинг объявлений;
  - `notifications` — оповещения (email/push/внутренние, без событийной шины);
  - административный контекст — управление пользователями, метрики ML.
- Для **каждого объявления обязательно есть арендодатель** (host), чтобы:
  - можно было написать ему из карточки объявления или из брони;
  - мессенджер мог строить диалог `guest ↔ host`.

Отдельный сервис `messaging`:
- выносится в отдельный процесс/контейнер;
- общается с основным backend по gRPC (backend для фронта остаётся единым HTTP‑фасадом);
- работает **только** с ScyllaDB (история чатов), не ходит в Mongo;
- основной backend работает только с Mongo и не пишет напрямую в Scylla.

### Frontend (React + Vite)

- SPA‑приложение на React + TypeScript с Tailwind как основным UI‑языком.
- Основные сценарии:
  - каталог объявлений и страница объекта;
  - мастер создания/редактирования объявления (шаги‑вкладки, которые должны быть кликабельными);
  - загрузка фотографий и работа с рекомендованной ценой (по ML);
  - создание бронирования;
  - страницы «Как это работает» и истории гостей;
  - личные кабинеты гостя и хоста;
  - админка (список пользователей, метрики, мессенджер).
- Конечная точка API задаётся через `VITE_API_BASE_URL`, без жёсткой привязки к конкретному домену backend.

### ML‑сервис (`mlrent`)

- Отдельный сервис на Python + FastAPI.
- Обучается на CSV‑датасетах в `mlrent/`:
  - текущая базовая схема:  
    `id,city,price,minutes,way,rooms,total_area,storey,storeys,renovation,building_age_years`;
  - в будущем — раздельные наборы для `short_term` и `long_term`.
- Основные признаки:
  - `city` → `Listing.Address.City`;
  - `rooms` → `Listing.Bedrooms`;
  - `total_area` → `Listing.AreaSquareMeters`;
  - `storey` / `storeys` → `Listing.Floor` / `Listing.FloorsTotal`;
  - `renovation` → `Listing.RenovationScore` (0–10);
  - `building_age_years` → `Listing.BuildingAgeYears`;
  - `minutes`, `way` — производные признаки, связанные с геоданными (пока могут задаваться заглушками).
- Планируется:
  - две модели: `short_term_model` и `long_term_model`;
  - либо один endpoint `/predict` с полем `rental_term`, либо два endpoint’а (`/predict/short`, `/predict/long`);
  - backend‑адаптер `MLPricingEngine` выбирает модель по типу аренды.

### Хранение данных

- Основная БД — MongoDB (монолитный backend).
- Хранилище фотографий — S3‑совместимое (MinIO); в домене хранятся только URL/ключи.
- История сообщений — ScyllaDB (колоночное хранилище для чатов), используется только сервисом `messaging`.

---

## Ключевые доменные решения

Подробная модель описана в `domain_model.md`. Здесь — только акценты:

- **Listing**:
  - хранит `HostID` (арендодатель), `RentalTermType` (`short_term`/`long_term`), параметры жилья и адрес (`City`, `Region`);
  - `MaxNights` может быть не задан (0 или `null` = «неограниченно»);
  - валидация публикации (`publish`) требует валидного адреса и разумных правил по ночам.
- **Pricing**:
  - всё ценообразование идёт через `pricing.Calculator` (in‑memory или ML‑адаптер);
  - ML‑подсказки используются и для посуточной, и для долгосрочной аренды, но по разным моделям;
  - итоговой правдой остаётся вручную заданная цена хоста.
- **Booking**:
  - полноценные заказы с диапазоном дат, статусами, итоговой ценой;
  - UX должен вести к созданию/просмотру брони, а не к абстрактным уведомлениям.
- **Reviews**:
  - отзывы формируют `Listing.Rating`, который можно использовать в поиске и аналитике;
  - рейтинг может в дальнейшем участвовать как вспомогательный сигнал в ML‑моделях.
- **Messaging & Admin**:
  - пользователи (guest/host/admin) используют один и тот же мессенджер;
  - в админке показывается список пользователей, админ может выбрать пользователя и открыть с ним диалог в том же интерфейсе чата;
  - диалоги привязываются к `Listing` и/или `Booking`, чтобы гость мог писать конкретному хосту по конкретному объявлению.

---

## Запуск (целевой сценарий)

Цель — поднять всю систему одной командой:

```bash
docker-compose up
```

При этом поднимаются:
- `rentme-backend` — Go‑backend;
- `rentme-frontend` — React‑frontend;
- `rentme-ml` — ML‑сервис из `mlrent/`;
- `mongo` — основная БД;
- `minio` (+ web‑консоль) — S3‑совместимое хранилище фотографий;
- `scylla` — хранилище истории чатов;
- (опционально) `messaging-service` — отдельный сервис мессенджера (gRPC + ScyllaDB).

Актуальное состояние `docker-compose.yml` и прогресс по интеграции описаны в `plan.md`.

---

## Документация

- `domain_model.md` — целевая доменная модель (Users, Listings, Pricing, Booking, Reviews, Messaging, Admin).
- `plan.md` — укрупнённый план развития (до 10 крупных задач).
- `mlrent/problem.md` — постановка задачи ML‑сервиса и связь с доменом.
- `mlrent/readme.md` — детали реализации ML‑сервиса и его HTTP‑API.
- `mlrent/plan.md` — план развития ML‑части (включая разделение моделей для short/long term).

Все архитектурные решения должны соответствовать требованиям из `AGENTS.md` в корне репозитория.

