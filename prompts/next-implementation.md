# Prompt: дореализация плана (Phase 2 demo-polish)

Ты один агент‑разработчик. Цель — довести продукт до “демо без стыда”: корректный long_term booking, понятное подтверждение брони хостом, быстрый переход в чат, и небольшие UX/ML правки.

Перед началом прочитай: `AGENTS.md`, `plan.md`, `demo.md`, `domain_model.md`, `docker-compose.yml`, `README.md`.

## Контекст

- Денежная модель уже “рубли везде”: `rate_rub`/`recommended_price_rub`, валюта `RUB`, без `*_cents`.
- ML прайсинг уже имеет клампы (`ML_PRICE_CLAMPS`) и скрипт проверки `scripts/validate_ml_pricing.ps1`.
- Дальше работаем по блоку “Дополнительные правки (после “рубли везде”)” в `plan.md`.

## Порядок работ (строго в таком порядке)

### 1) Booking long_term: исправить цену и UX дат (P0)

Проблема: long_term сейчас считается как “цена за месяц × кол-во дней”, и UX требует дату выезда как в short_term.

Сделай:
- В UI создания брони для `long_term`:
  - убрать выбор даты выезда;
  - вместо этого выбрать **длительность в месяцах** (минимум 1, максимум 12 для демо) или фиксированную длительность (например 1/3/6/12).
- На backend:
  - расчёт стоимости `long_term`: `rate_rub` × `months` (без дней);
  - `short_term` остаётся посуточным: `rate_rub` × `nights`.
- Модель/DTO: убедиться, что бронь хранит (и отдаёт) понятные поля для long_term (например `months`, `price_unit=month`).

Acceptance:
- Создаю бронь long_term на 3 месяца → total = `rate_rub * 3` (в RUB) и корректно отображается в “Мои бронирования”.
- Создаю бронь short_term на 7 ночей → total = `rate_rub * 7` (в RUB) и не ломается.

### 2) Pending booking: сделать понятное подтверждение хостом (P0)

Проблема: после брони статус “ожидает подтверждение”, но у хоста нет очевидного места, где увидеть и подтвердить.

Сделай:
- Экран/раздел у хоста “Запросы на бронь” (pending):
  - список входящих броней по его объявлениям;
  - кнопки “Подтвердить” и “Отклонить”.
- Обновление статуса должно быть видно:
  - гостю в “Мои брони”;
  - хосту в “Мои брони/Запросы”.

Acceptance:
- Guest создаёт бронь → Host видит её в pending → подтверждает → статус меняется на confirmed (или аналогичный) у обоих.

### 3) “Мои бронирования”: кнопка “Перейти в чат” (P0)

Сделай:
- На карточке каждой брони в “Мои бронирования” добавить кнопку “Перейти в чат”.
- Переход открывает чат с контрагентом:
  - host открывает диалог с guest;
  - guest открывает диалог с host;
  - желательно, чтобы диалог был привязан к `booking_id` (если это поддерживается текущим messaging API), иначе — к `listing_id`.

Acceptance:
- Для любой брони есть кнопка → открывается нужный чат → можно отправить сообщение.

### 4) Просмотр объявления: модалка/окно карточки не помещается (P1)

Исправить UI так, чтобы окно просмотра объявления:
- помещалось в viewport по высоте;
- имело скролл внутри контента, а не ломало страницу;
- CTA не были обрезаны.

Acceptance:
- Проверка на ширинах ~360px и ~1280px, без “обрезанных” элементов.

### 5) Каталог: бейдж “Ваше объявление” (P1)

Если пользователь `host` видит в каталоге своё объявление:
- показать бейдж “Ваше объявление”;
- скрыть/disabled “Написать арендодателю” (если есть).

Acceptance:
- Под host‑аккаунтом видно, какие карточки принадлежат ему.

### 6) ML: добавить `transit` и поправить влияние ремонта (P1)

Сделай:
- ML контракт: `way` поддерживает `walk|car|transit`.
- `mlrent/ml.py`: корректно кодировать `transit` (например отдельным числом).
- Backend: уметь передать `travel_mode=transit`.

И “слегка адекватизировать” влияние `renovation_score`:
- На 2–3 эталонных профилях при прочих равных повышение `renovation_score` **не снижает** прогноз.
- Разрешено: править CSV‑датасеты, генерацию данных, гиперпараметры модели (в рамках sklearn).

Acceptance:
- `POST /predict` с `way=transit` работает.
- На смоук‑профиле “renovation 3 -> 8” цена не падает.

## Проверка (обязательно выполнить)

1) `docker compose up -d --build`
2) `powershell -ExecutionPolicy Bypass -File scripts/validate_ml_pricing.ps1`
3) Пройти руками `demo.md` + добавить 2 сценария:
   - long_term бронь на 3 месяца → confirm host → чат
   - short_term бронь на 7 ночей → confirm host → чат

## Выходной отчёт (в конце)

- Список изменённых endpoint’ов/полей (старое -> новое, если трогал).
- Команды проверки (что запускал).
- Короткий чек‑лист: что руками проверять перед демо.
