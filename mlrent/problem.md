## Проблема: ML‑сервис ценообразования для Rentme

Цель — встроить ML‑сервис, который по атрибутам квартиры даёт **оценочную стоимость аренды** (ночная ставка / месяц), и аккуратно интегрировать его в существующую архитектуру Rentme (модульный монолит Go + отдельный ML‑сервис).

Сейчас:
- домен **pricing** уже существует (`internal/domain/pricing`), но реализован через простейший детерминированный калькулятор (`memory.PricingEngine`);
- ML‑код и данные живут отдельно в `mlrent/` (`ml.py`, `clean_train.csv`, `clean_test.csv`);
- схема признаков в ML и схема доменной модели квартиры (**Listing**) частично не совпадают.

Ниже — срез полей и рекомендации, что стоит держать на бэкенде, а что в ML.

---

### 1. Поля в ML‑датасете (`clean_train.csv` / `clean_test.csv`)

Текущие колонки (кроме индекса):
- `metro` — название станции метро;
- `price` — цена аренды (скорее всего в месяц, рубли);
- `minutes` — минуты до метро;
- `way` — способ добраться до метро (`walk` / `transport`);
- `provider` — тип поставщика (`agency` / `realtor` / `owner`);
- `fee_percent` — комиссия агенту в процентах;
- `views` — количество просмотров объявления;
- `storey` — этаж квартиры;
- `storeys` — всего этажей в доме;
- `rooms` — количество комнат;
- `total_area` — общая площадь;
- `living_area` — жилая площадь;
- `kitchen_area` — площадь кухни;
- `living_total_ratio` — отношение жилой к общей площади;
- `rooms_per_total_area` — комнат на метр;
- `storey_ratio` — этаж / этажность.

Реально модель может использовать подмножество этих признаков либо агрегировать их в более удобный набор.

---

### 2. Поля квартиры на бэкенде (домен `Listing`)

Ключевые поля `Listing` (см. `internal/domain/listings/listing.go`):
- Идентификаторы и метаданные:
  - `ID`, `Host`, `Title`, `Description`, `PropertyType`, `State`, `Tags`, `Highlights`;
- Локация:
  - `Address{ Line1, Line2, City, Country, Lat, Lon }`;
- Характеристики размещения:
  - `GuestsLimit`, `MinNights`, `MaxNights`,
  - `Bedrooms`, `Bathrooms`,
  - `AreaSquareMeters`,
  - `Amenities`, `HouseRules`;
- Ценообразование и качество:
  - `NightlyRateCents` — цена за ночь;
  - `CancellationPolicyID`, `Rating`;
- Медиа и время:
  - `ThumbnailURL`, `Photos`, `AvailableFrom`, `CreatedAt`, `UpdatedAt`.

Также уже есть слой **pricing** с сущностью `PriceBreakdown` и интерфейсом `Calculator`, а на уровне приложения — `HostListingPriceSuggestionHandler`, который умеет возвращать хосту рекомендованную цену по `PricingPort`.

---

### 3. Сопоставление полей ML ↔ backend и рекомендации

#### 3.1. Поля, которые логично добавить в домен Listing

Эти атрибуты полезны не только для ML, но и для пользователя (фильтры, карточка жилья), поэтому их разумно хранить в `Listing` и БД:

- `storey` ↔ **этаж**
  - Добавить в `Listing`: `Floor int`.
  - Использование: фильтрация, удобство для арендатора, важный фактор цены.

- `storeys` ↔ **этажность дома**
  - Добавить в `Listing`: `FloorsTotal int`.
  - Использование: влияние на цену, возможность фильтровать «не выше N‑го этажа».

- `rooms` ↔ **комнаты / спальни**
  - В домене уже есть `Bedrooms int`.
  - Рекомендация: трактовать колонку `rooms` как источник для `Bedrooms` при генерации данных. Отдельное поле `Rooms` в домене не обязательно, если Rentme работает в логике «количество спален».

- `total_area` ↔ **общая площадь**
  - Уже есть `AreaSquareMeters float64`.
  - Рекомендация: при генерации данных из ML или фикстур маппить `total_area` на `AreaSquareMeters`.

- `living_area`, `kitchen_area`
  - Добавить в `Listing`:
    - `LivingAreaSquareMeters float64`;
    - `KitchenAreaSquareMeters float64`.
  - На бэкенде они полезны как часть карточки объекта; в ML можно дополнительно использовать их и/или их отношение к общей площади.

- `minutes` (до метро)
  - Добавить в `Listing` поле уровня адреса или самого объявления:
    - вариант А: `Address.TransportMinutes int` (обобщённо «минут до ключевого транспортного узла»);
    - вариант B: `DistanceToMetroMinutes int` прямо в `Listing`.
  - Рекомендация: выбрать нейтральное именование («до транспорта»), чтобы работать не только с метро и не только с Москвой.

#### 3.2. Поля, которые стоит оставить только в ML / аналитике, не в домене Listing

Эти признаки полезны для модели, но являются скорее **поведенческими** или **канальными** метриками, а не атрибутами самой квартиры:

- `provider` (`agency` / `realtor` / `owner`)
  - В Rentme есть `Host` и домен `user`, но нет явного типа «агент / владелец».
  - Рекомендация:
    - краткосрочно — **убрать из первой версии ML‑модели**, чтобы не тянуть лишнюю доменную сущность;
    - в будущем — при необходимости добавить в `user` роль/тип хоста и использовать это как отдельный признак.

- `fee_percent` (комиссия агенту)
  - В домене pricing уже есть понятие сборов и комиссий (`Fees`, `Taxes`, `Discounts`).
  - Рекомендация:
    - не хранить `fee_percent` как атрибут Listing;
    - если нужно, моделировать комиссию как часть `PriceBreakdown` (инфраструктура/политики), а в ML использовать итоговую цену целиком.

- `views` (просмотры объявления)
  - Это метрика поведения пользователей (относится к аналитике/маркетингу).
  - Рекомендация:
    - не добавлять в `Listing`;
    - при необходимости использовать в ML отдельный поток фичей из системы аналитики (events → агрегаты), но это уже следующий уровень сложности.

#### 3.3. Поля, которые лучше считать производными и вычислять в ML‑коде

Эти колонки уже являются функциями других признаков и **не должны** храниться на бэкенде:

- `living_total_ratio` = `living_area / total_area`;
- `rooms_per_total_area` = `rooms / total_area`;
- `storey_ratio` = `storey / storeys`.

Рекомендация:
- хранить только базовые поля (`AreaSquareMeters`, `LivingAreaSquareMeters`, `KitchenAreaSquareMeters`, `Floor`, `FloorsTotal`, `Bedrooms`);
- производные признаки считать в питон‑коде при подготовке данных и в онлайн‑фиче‑инженеринге.

#### 3.4. Поля, которые есть на бэкенде и полезны для добавления в ML

ML‑датасет сейчас их не содержит, но они уже есть в домене и могут улучшить качество модели:

- `PropertyType` — тип недвижимости (`loft`, `duplex`, `studio` и т.п.);
- `City`, `Country`, `Lat`, `Lon` — локация;
- `GuestsLimit`, `MinNights`, `MaxNights` — ограничения по размещению;
- `Bedrooms` и `Bathrooms` (если в данных используем `rooms` как bedrooms, можно добавить `bathrooms` как отдельный признак);
- `Amenities`, `Tags`, `Highlights` — можно закодировать количеством/one‑hot топ‑N признаков;
- `Rating` — отражает качество, часто коррелирует с ценой.

Рекомендация:
- новая версия ML‑датасета должна строиться **из снапшота Listing** в БД (плюс синтетика), а не из внешнего набора колонок;
- при генерации обучающего набора использовать ровно те поля, которые доступны в рантайме для сервиса.

---

### 4. Целевая роль ML‑сервиса в архитектуре

- ML‑сервис реализует **оценку справедливой ночной цены** и становится реализацией доменного интерфейса `pricing.Calculator` (через адаптер в `internal/infra`).
- Go‑код по‑прежнему работает с `QuoteInput{ ListingID, Range, Guests }`, а адаптер по `ListingID` достаёт `Listing` и формирует фичи для ML.
- Точка входа для хоста уже есть — `HostListingPriceSuggestionHandler` и эндпоинт `/api/v1/host/listings/:id/price-suggestion`; под капотом вместо детерминированного `PricingEngine` будет использован ML‑сервис.

Таким образом, доменная модель остаётся чистой и пригодной для будущего выделения pricing в отдельный сервис, а ML‑часть живёт в `mlrent/` и/или отдельном контейнере, общаясь с Go по стабильному API.

