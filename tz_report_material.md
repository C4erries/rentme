# Материалы для отчёта (ТЗ) по проекту Rentme

Этот файл — заготовка с содержанием и формулировками, которые удобно переносить в официальный отчёт/ТЗ (по структуре, близкой к `doc.md`).

Rentme — учебный маркетплейс аренды жилья (аналог Airbnb) для РФ с двумя типами аренды:
- `short_term` — посуточная (тариф за ночь);
- `long_term` — долгосрочная (тариф за месяц).

Система состоит из:
- Backend (Go + Gin, модульный монолит, MongoDB);
- ML-сервис ценообразования (FastAPI, две модели: short/long);
- Messaging-service (Go, gRPC, ScyllaDB) — отдельный сервис чатов;
- Хранилище фото (S3-совместимое, MinIO в dev);
- Frontend (React + Vite + Tailwind).

Событийная архитектура и Kafka **не используются**.

---

## 1. Общие сведения

### 1.1. Используемые термины и сокращения

| Термин/сокращение | Расшифровка |
|---|---|
| ИС | Информационная система |
| БД | База данных |
| СУБД | Система управления базами данных |
| HTTP | Протокол передачи гипертекста |
| JSON | Формат обмена данными |
| gRPC | RPC-фреймворк поверх HTTP/2 |
| S3 | S3-совместимое объектное хранилище |
| MinIO | S3-совместимое хранилище для dev/демо |
| ML | Машинное обучение |
| MAE/RMSE | Метрики качества модели ML |
| CSV | Текстовый формат табличных данных |
| RBAC | Role-Based Access Control (роли и права) |
| Guest | Пользователь-арендатор, ищет жильё и бронирует |
| Host | Пользователь-арендодатель, публикует объявления |
| Admin | Администратор системы |
| Listing | Объявление о жилье |
| Booking | Бронирование жилья |
| Review | Отзыв по завершённой аренде |
| Conversation/Message | Диалог/сообщение в чате |
| `short_term` | Посуточная аренда (тариф за ночь) |
| `long_term` | Долгосрочная аренда (тариф за месяц) |
| `rate_cents` | Стоимость в копейках (за ночь/месяц в зависимости от `price_unit`) |
| `price_unit` | Единица тарифа: `night` или `month` |

### 1.2. Цели изменений (доработок) системы

| Цель | Критерии достижения |
|---|---|
| Реализовать маркетплейс аренды жилья | Пользователь может зарегистрироваться, видеть каталог, открывать карточки объявлений |
| Автоматизировать бронирование | Пользователь может создать бронь, видеть её в списке и статус |
| Улучшить коммуникации host↔guest | Пользователь может открыть чат по объявлению и переписываться; есть индикация непрочитанных |
| Обеспечить хранение фото объявлений | Хост может загрузить фото; фото доступны в карточке и в списках |
| Предоставить ML-подсказку цены | Для `short_term` и `long_term` выдаётся отдельная рекомендация по соответствующей модели |
| Добавить админ-инструменты | Админ видит список пользователей, может написать любому и видеть метрики ML |
| Воспроизводимый запуск для демо | Всё поднимается через `docker compose`; доступен “чистый старт”; есть demo-аккаунты/seed |

### 1.3. Область применения

Разрабатываемая система применяется для автоматизации деятельности маркетплейса аренды жилья и предназначена для категорий пользователей:
- Клиенты (Guest): просмотр каталога, бронирование, отзывы, чат с арендодателем.
- Арендодатели (Host): создание/управление объявлениями, загрузка фото, публикация, чат с гостями, использование ML-подсказок цены.
- Администраторы (Admin): управление пользователями, коммуникации и мониторинг метрик ML.

Ограничения и допущения учебного проекта:
- Работа в рамках РФ: адреса ведутся по `city` + `region` (страна не требуется).
- Платежи и процессинг — вне текущего scope (могут быть описаны как развитие).
- Карты/геокодинг — вне текущего scope (в будущем можно интегрировать).

Используемые технологии:
- Backend: Go (Gin), MongoDB.
- ML: Python (FastAPI, scikit-learn).
- Чаты: gRPC + ScyllaDB.
- Фото: MinIO (S3) для dev.
- Frontend: React + TypeScript + Tailwind.
- DevOps: Git, Docker, Docker Compose.

### 1.4. Описание изменения бизнес-процессов (как будет)

#### 1.4.1. Бизнес-процесс гостя (Guest)
1) Открывает каталог → выбирает тип аренды (`short_term`/`long_term`) → применяет фильтры.
2) Открывает карточку объявления → изучает фото/описание/правила/характеристики и видит цену:
   - `short_term`: “за ночь”;
   - `long_term`: “за месяц”.
3) Создаёт бронирование, указывая даты и гостей → получает подтверждение создания и видит бронь в “Моих бронированиях”.
4) При необходимости нажимает “Написать арендодателю” → создаётся/открывается чат по объявлению → отправляет сообщения.
5) После завершения проживания оставляет отзыв по бронированию (ограничение: отзыв допускается только после окончания срока проживания).

#### 1.4.2. Бизнес-процесс арендодателя (Host)
1) Проходит онбординг хоста: “Стать хостом” → в учебном режиме заявка автопринята (роль `host` выдана автоматически).
2) Создаёт объявление в мастере:
   - выбирает `rental_term`;
   - заполняет поля объявления (адрес, характеристики, правила);
   - загружает фото и выбирает обложку;
   - задаёт цену (за ночь/месяц) и при необходимости запрашивает ML-рекомендацию, применяя её в форму.
3) Публикует объявление (валидация адреса обязательна).
4) Получает сообщения от гостей, ведёт переписку, видит непрочитанные.

#### 1.4.3. Бизнес-процесс администратора (Admin)
1) Входит под ролью `admin` и открывает админ-панель.
2) Просматривает список пользователей, ищет нужного пользователя.
3) Открывает чат и пишет пользователю (диалог как у обычных пользователей).
4) Просматривает метрики ML-моделей (short/long) и базовую статистику.

---

## 2. Требования к изменяемой подсистеме

Реализовать систему, состоящую из следующих функциональных блоков:
1) Регистрация и авторизация.
2) Каталог и карточка объявления (поиск, фильтры, сортировка, пагинация).
3) Мастер создания/редактирования объявления хоста.
4) Фото объявлений (загрузка и хранение).
5) Бронирования (создание и управление).
6) Отзывы (по завершённым бронированиям).
7) Чаты (общение host↔guest и admin↔user).
8) ML-подсказки цены (две модели, short/long) + метрики.
9) Админ-панель (пользователи, чаты, метрики).

Архитектурные ограничения:
- основной backend работает с MongoDB;
- сервис чатов — отдельный сервис, работает только со ScyllaDB и доступен по gRPC;
- событийная архитектура/Kafka не применяется.

### 2.1. Требования к функционалу

#### 2.1.1. Регистрация и авторизация
Для пользователей (Guest/Host/Admin) должна быть реализована:
- регистрация по e-mail и паролю;
- авторизация по e-mail и паролю;
- хранение пароля только в виде хэша.

Минимальные поля регистрации (рекомендуемые):
- Имя (или отображаемое имя);
- e-mail;
- пароль + подтверждение пароля;
- согласие на обработку персональных данных (для отчёта).

#### 2.1.2. Функционал неавторизованного пользователя
Неавторизованному пользователю доступно:
- главная страница;
- просмотр каталога объявлений;
- фильтрация и сортировка;
- просмотр карточки объявления;
- переход на регистрацию/вход.

#### 2.1.3. Функционал авторизованного пользователя (Guest)
Авторизованному гостю доступно:
- всё из функционала неавторизованного;
- создание бронирования (booking) и просмотр “Моих бронирований”;
- создание/открытие чата с хостом по объявлению;
- отправка сообщений, чтение истории, отображение “непрочитано”;
- оставление отзыва по завершённому бронированию;
- подача заявки “Стать хостом”.

#### 2.1.4. Онбординг хоста и функционал Host
При переходе гостя в host-часть приложения система должна:
- показать сообщение о необходимости стать хостом;
- предоставить кнопку “Стать хостом”;
- в учебном режиме автоматически назначить роль `host` без отдельной модерации.

Хосту доступны:
- создание объявления;
- редактирование объявления;
- загрузка фото, выбор обложки;
- публикация/снятие с публикации;
- управление ценой и запрос ML-рекомендации;
- переписка с гостями в чатах.

#### 2.1.5. Каталог и карточка объявления
Каталог должен поддерживать:
- переключатель типа аренды: `short_term` / `long_term` (влияет на состав выдачи и отображение цены);
- фильтры: локация (город/регион), даты, гости, цена, тип жилья, др.;
- сортировки: цена, рейтинг, новизна;
- пагинацию.

Карточка объявления должна отображать:
- фото и обложку;
- заголовок, описание, адрес (город/регион), характеристики;
- цену с единицей (`price_unit`) и доступность;
- кнопку “Забронировать” и “Написать арендодателю”.

#### 2.1.6. Бронирования
Система бронирований должна обеспечивать:
- создание бронирования по объявлению;
- валидацию дат и ограничений (мин ночей, макс ночей; макс может быть “без ограничений”);
- хранение и отображение статусов брони;
- доступ к брони только владельцу (guest) и владельцу объявления (host) в рамках своих прав.

#### 2.1.7. Отзывы
Система отзывов должна обеспечивать:
- оставление отзыва по бронированию только после завершения проживания;
- запрет дубликатов отзывов по одному бронированию от одного автора;
- отображение отзывов в карточке объявления.

#### 2.1.8. Чаты
Подсистема чатов должна обеспечивать:
- создание/поиск диалога по объявлению (guest↔host);
- отправку и получение сообщений;
- хранение истории сообщений (ScyllaDB);
- индикацию непрочитанных диалогов;
- для админа: возможность создать диалог и писать любому пользователю.

#### 2.1.9. ML-подсказка цены (short/long)
ML-подсказка цены должна:
- работать отдельно для `short_term` (за ночь) и `long_term` (за месяц);
- использовать **разные модели** и **разные датасеты**:
  - long-term: базовые CSV (90% train / 10% test);
  - short-term: синтетический CSV (90%/10%), с диапазонами признаков, близкими к long-term датасету, но с “ночными” ценами.

ML API должен принимать (минимум):
`city`, `rooms`, `total_area`, `storey`, `storeys`, `renovation`, `building_age_years`, `minutes`, `way`, `rental_term`.

#### 2.1.10. Админ-панель
Админ-панель должна включать:
- список пользователей (поиск/фильтр);
- старт диалога с пользователем и переписка;
- метрики моделей ML (качество и размеры train/test; базовая статистика).

### 2.2. Требования к ролям

Роли:
- `guest` — базовая роль после регистрации.
- `host` — владелец объявлений.
- `admin` — доступ к админ-маршрутам и операциям админа.

Права доступа (укрупнённо):
- `guest`: каталог, карточка, брони (свои), отзывы (свои), чаты (как участник), онбординг хоста.
- `host`: CRUD своих объявлений + фото, публикация, ML-рекомендация, чаты (как участник), доступ к бронированиям своих объявлений.
- `admin`: `/admin/*`, список пользователей, админ-чат, просмотр ML-метрик.

### 2.3. Требования к интерфейсам

#### 2.3.1. Пользовательские интерфейсы (UI)
Обязательные страницы/разделы:
- Каталог.
- Карточка объявления.
- Мои бронирования.
- Чаты (список и диалог).
- Мои объявления (для хоста) и мастер создания/редактирования.
- Админка (пользователи, ML-метрики).

Требования:
- единый общий header на всех страницах;
- мастер объявления: кликабельные шаги (возможность перейти на этап напрямую);
- интерфейс адаптивный (ПК/планшет/смартфон) на Tailwind.

#### 2.3.2. Интеграционные интерфейсы

Backend REST API (HTTP/JSON):
- публичные ручки каталога и карточек;
- ручки гостя: брони, отзывы, чаты;
- ручки хоста: объявления, публикация, фото (multipart), ML-рекомендации;
- админ-ручки: пользователи, ML-метрики.

ML сервис (HTTP/JSON):
- `/predict` (совместимость) и/или специализированные `/predict/short`, `/predict/long`;
- `/metrics` — метрики качества short/long.

Messaging-service (gRPC):
- операции получения списка чатов, истории сообщений, отправки сообщения;
- операции отметки “прочитано” и вычисление “has_unread”.

S3 (MinIO) для фото:
- загрузка объектов в bucket;
- выдача публичных URL (для демо возможно `public-read`, как учебное упрощение).

### 2.4. Требования к миграции и изменению потоков данных

#### 2.4.1. Seed/demo данные
Необходимо обеспечить заполнение базы сгенерированными данными:
- минимум 30 объявлений `short_term` и 30 объявлений `long_term`;
- несколько разных арендодателей (например, 2 агентства + 2 частника);
- данные должны быть похожи по распределениям на значения в CSV-датасетах (город, площадь, этаж, ремонт, возраст дома и т.д.).

#### 2.4.2. Потоки данных (Data Flow)
- Создание/редактирование объявления:
  - Frontend → Backend (JSON) → MongoDB.
- Загрузка фото:
  - Frontend → Backend (multipart) → S3/MinIO → сохранение URL в MongoDB.
- ML-рекомендация:
  - Frontend → Backend → ML сервис → ответ `recommended_price` → отображение/применение в форме.
- Чат:
  - Frontend → Backend REST → gRPC в messaging-service → ScyllaDB → возврат истории/статуса непрочитанных.
- Админ метрики:
  - Frontend → Backend REST → ML `/metrics`.

### 2.5. Нефункциональные требования (Качество ПО)

Производительность (ориентиры для учебного проекта):
- время ответа каталога при типовых фильтрах — до 2 секунд;
- время ответа карточки объявления — до 2 секунд;
- отправка сообщения в чат — до 2 секунд (при доступных сервисах).

Безопасность:
- хранение пароля только в виде хэша;
- разграничение доступа по ролям (RBAC);
- ограничение размера и типа файлов при загрузке фото;
- рекомендуется HTTPS для прод окружений (для dev допускается HTTP).

Масштабируемость:
- архитектура позволяет дальнейшее выделение сервисов (чат уже вынесен);
- отдельные компоненты масштабируются независимо (ML/чат/фото).

Совместимость:
- корректная работа в современных браузерах (Chrome/Yandex/Firefox/Edge/Safari).

Юзабилити:
- понятный мастер создания объявления;
- единые тексты/локализация, корректная кириллица;
- адаптивная вёрстка.

Надёжность/деградация:
- при недоступности ML сервисов — понятная ошибка и отсутствие падения backend;
- при недоступности чата — понятная ошибка и логирование причины.

Сопровождаемость:
- документация и инструкции запуска;
- контроль версий Git;
- запуск через Docker Compose.

Наблюдаемость:
- структурированные логи с ключами `user_id`, `listing_id`, `booking_id`, `conversation_id`;
- тайм-ауты на внешние вызовы (ML, gRPC).

### 2.6. Справочная информация по объектам (СИ)

> Формат “где хранится + ключевые атрибуты + ограничения” — достаточен для учебного отчёта.

#### User
- Хранилище: MongoDB (`users`).
- Атрибуты: `id`, `email` (уникально), `name`, `password_hash`, `roles[]`, `created_at`.

#### Listing (Объявление)
- Хранилище: MongoDB (`listings`).
- Атрибуты:
  - `id`, `host_id` (обязательно);
  - `rental_term` (`short_term`/`long_term`);
  - адрес: `city`, `region`, `line1` (обязательно), `line2` (опц.);
  - параметры: `guests_limit`, `bedrooms`, `bathrooms`, `area_sq_m`;
  - дом: `floor`, `floors_total`, `renovation_score (0..10)`, `building_age_years`;
  - медиа: `photo_urls[]`, `thumbnail_url`;
  - цена: `rate_cents`, `price_unit` (`night`/`month`).

#### Booking (Бронирование)
- Хранилище: MongoDB (`bookings`).
- Атрибуты: `id`, `listing_id`, `guest_id`, `check_in`, `check_out`, `status`, итоговая стоимость/поля расчёта.

#### Review (Отзыв)
- Хранилище: MongoDB (`reviews`).
- Атрибуты: `id`, `listing_id`, `booking_id`, `author_id`, `rating`, `text`, `created_at`.
- Ограничение: один отзыв от автора на одно бронирование.

#### Conversation / Message (Чаты)
- Хранилище: ScyllaDB (`rentme_messaging`), таблицы `conversations`, `messages`, `conversation_reads` (или эквивалент).
- Атрибуты диалога: `conversation_id`, `participant_ids[]`, `listing_id` (опц.), `last_message_id`, `has_unread`.
- Атрибуты сообщения: `message_id`, `conversation_id`, `sender_id`, `text`, `created_at`.

#### Photo object (S3)
- Хранилище: MinIO bucket (например, `rentme-photos`).
- Ключи объектов: `listings/<listing_id>/<uuid>.<ext>`.

#### ML datasets / metrics
- Хранилище: файлы `mlrent/clean_train_long.csv`, `mlrent/clean_test_long.csv`, `mlrent/clean_train_short.csv`, `mlrent/clean_test_short.csv`.
- Метрики: `MAE`, `RMSE`, размеры train/test отдельно для short/long.

---

## 3. План внедрения

### 3.1. Подготовка окружения
1) Установить Docker + Docker Compose.
2) Запустить проект: `docker compose up --build`.
3) Для “чистого старта” (удаление всех volumes): `docker compose down -v --remove-orphans`.

### 3.2. Подготовка demo-данных
1) Поднять сервисы Mongo/Scylla/MinIO.
2) Сгенерировать/загрузить seed-данные (хосты + объявления `short_term`/`long_term`).
3) Проверить доступность demo-аккаунтов (см. `demo.md`).

### 3.3. Приёмочные сценарии (smoke)
- Guest: каталог → карточка → бронь → чат с хостом → отзыв после завершения.
- Host: стать хостом → создать объявление → загрузить фото → ML-рекомендация → публикация.
- Admin: список пользователей → написать пользователю → открыть ML-метрики.

---

## Примечания
- Учебный проект: платежи/карты/модерация можно описывать как “вне текущего scope/план развития”.
- Данные для обучения и наполнения базы могут генерироваться (в т.ч. нейросетями), но должны быть статистически похожи на CSV-датасеты каждого сегмента (`short_term`/`long_term`).
