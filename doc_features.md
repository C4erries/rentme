++md
# Продуктовые фичи Rentme

Документ описывает, какие пользовательские сценарии должны поддерживаться в рамках текущей итерации Rentme и что уже реализовано или должно быть до демо.

## 1. Функционал для покупателя/гостя

### 1.1. Неавторизованный гость

До входа в систему гостю доступно:
- Главная страница с подборкой актуальных объявлений и ссылками на каталог, регистрацию и вход.
- Каталог жилья с фильтрами по типу аренды (`short_term`/`long_term`), цене, городу, наличию фотографий.
- Просмотр карточки объявления (модалка / отдельный экран) с основными данными, стоимостью, отзывами и кнопкой “Написать хосту”.
- Кнопки “Регистрация” и “Вход”, которые быстро переводят на соответствующие формы.

Главная страница содержит:
- Сетку/слайдер “Популярные объекты” (title, photo, краткое описание).
- Блок “Как Rentme работает” + CTA “Перейти в каталог”.

Каталог:
- Показывает карточки объявлений: фото, название, город, цена (price_unit), теги.
- Фильтры: тип аренды, город, диапазон `rate_rub`, количество гостей, наличие свободных дат.
- Сортировка: цена, рейтинг, новизна.
- Возможность мультивыбора фильтров.

Карточка объявления:
- Информация: заголовок, адрес, описание, amenities, правила, хозяин.
- Фото-галерея с прокруткой.
- Зоны “Рекомендованная цена / текущая цена”, “Отзывы / рейтинг”.
- CTA “Посмотреть детали / забронировать”, “Написать хосту”.

### 1.2. Авторизованный гость

Авторизованный гость наследует функционал гостя и получает дополнительно:
- Создание брони (short_term и long_term) через мастера объявления.
- Раздел “Мои брони”:
  - Список предстоящих, прошлых и отменённых броней.
  - Для `long_term` отображается `months` и `price_unit=month`.
  - У каждой брони есть кнопка “Перейти в чат”.
- Чат с хостом: можно открыть из каталога/карточки/брони, отправлять сообщения, видеть историю.
- Оставление отзыва после завершённого проживания (один отзыв на бронь).
- Профиль: список бронирований, быстрые переходы в чат, отзывы.

При оформлении брони:
- `short_term`: выбирается `check_in`, `check_out`.
- `long_term`: выбирается `check_in` и длительность в месяцах (1–12), `check_out` рассчитывается автоматически.
- Стоимость: `rate_rub * nights` для посуточных и `rate_rub * months` для долгосрочных.
- Кнопка подтверждения / отмены брони отражает статус (pending → confirmed/declined).

## 2. Функционал хоста

Хост получает:
- Мастер создания объявления: название, описание, адрес, параметры, фото, price_unit, `rate_rub`.
- Поддержку работы с фотографиями (upload через S3).
- Возможность публиковать/снимать объявление, хранить состояние (`draft`, `active`, `suspended`).
- Цена: ввод `rate_rub`, `price_unit`, запрос ML-подсказки.
- Список своих объявлений с фильтрацией по статусу.
- Раздел “Запросы на бронирование” (pending):
  - Список входящих броней.
  - Кнопки “Подтвердить” / “Отклонить”.
  - Просмотр статусов подтверждён/отклонён/ожидает.
- Переписка с гостями (в рамках каждой брони/объявления).
- Админских CTA вида “Посмотреть ML-метрики”.

## 3. Функционал администратора

Админ обладает всем функционалом хоста и дополнительно:
- Управление пользователями: просмотр списка гостей/хостов, добавление/удаление сотрудников (admin/manager).
- Доступ к ML-метрикам (`/ml/metrics`).
- Возможность писать сообщения любому пользователю (через тот же chat API).

## 4. Каталог и бронирования

- Каталог реализован в виде бесконечной ленты (infinite-scroll) карточек объявлений.
- Каждая карточка содержит `rate_rub`, `price_unit`, `host_id`, `rental_term`, `tags`, `rating`.
- Фильтры по типу аренды, диапазону цен, городу, свободным датам.

- Система бронирований:
  - Валидация дат (min/max nights, unlimited).
  - Доступ к брони имеют только:
    * Гость, который сделал бронь.
    * Хост объявления
- Статусы: `PENDING`, `CONFIRMED`, `DECLINED`, `CHECKED_IN`, `CHECKED_OUT`.

## 5. ML-подсказки цены

- Сервис `mlrent` обучен на polynomial regression с LASSO.
- При запросе `/predict` ML ожидает: `city`, `way` (walk/car/transit), `rooms`, `total_area`, `storey`, `storeys`, `renovation`, `building_age_years`, `rental_term`, `current_price`.
- По результату:
  - Backend не только принимает `recommended_price`, но и применяет kлампы (`ML_PRICE_CLAMPS`) по городу/терму.
  - Логи содержат: `city_raw`, `city_normalized`, `rental_term`, `ml_price_raw`, `ml_price_final`, `clamped`.

